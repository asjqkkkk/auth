<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Google Drive Picker 调试</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC",
          "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        line-height: 1.5;
        background: #f5f7fb;
      }

      body {
        margin: 0;
        padding: 0;
        background: #f5f7fb;
        color: #0f172a;
      }

      main {
        max-width: 880px;
        margin: 0 auto;
        padding: 2.5rem 1.5rem 4rem;
      }

      .card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.08);
      }

      h1,
      h2 {
        margin-top: 0;
      }

      p {
        margin-bottom: 1rem;
      }

      code,
      pre {
        font-family: "SFMono-Regular", Menlo, Consolas, monospace;
        font-size: 0.85rem;
      }

      pre {
        background: #0f172a;
        color: #f8fafc;
        padding: 1rem;
        border-radius: 0.75rem;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .actions {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .button {
        border: none;
        border-radius: 999px;
        background: #2563eb;
        color: white;
        padding: 0.65rem 1.5rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 12px 32px rgba(37, 99, 235, 0.25);
      }

      .button.secondary {
        background: #0f172a;
        box-shadow: none;
      }

      .button:disabled {
        background: #94a3b8;
        box-shadow: none;
        cursor: not-allowed;
      }

      .status {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 0.75rem;
        background: rgba(37, 99, 235, 0.08);
      }

      .status ul {
        margin: 0.5rem 0 0;
        padding-left: 1.25rem;
      }

      .status strong {
        display: inline-block;
        min-width: 120px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        font-size: 0.8rem;
        background: rgba(15, 23, 42, 0.05);
        padding: 0 0.5rem;
        border-radius: 999px;
        margin-left: 0.5rem;
      }

      .instructions {
        background: rgba(15, 23, 42, 0.05);
        border-radius: 0.75rem;
        padding: 1rem;
      }
    </style>
  </head>
  <body>
    <main>
      <section class="card">
        <h1>Google Drive Picker 调试页</h1>
        <p>
          该页面用于在审核或调试环境中唤起 Google Drive Picker。它假设
          OAuth 流程与 Access Token 已在客户端（例如 Flutter App）
          完成，并允许通过 JS Channel / <code>postMessage</code>
          注入必要的配置参数。
        </p>

        <div class="status" id="statusPanel">
          <h2>当前状态</h2>
          <p>正在加载 Google API…</p>
        </div>

        <div class="actions">
          <button class="button" id="openPickerBtn" type="button" disabled>
            打开 Drive Picker
          </button>
          <button class="button secondary" id="resetConfigBtn" type="button">
            重置配置
          </button>
        </div>

        <h2>当前配置</h2>
        <pre id="configView">(待注入)</pre>

        <h2>Picker 回调</h2>
        <pre id="resultView">(尚未唤起 Picker)</pre>

        <h2>JS Channel / postMessage</h2>
        <div class="instructions">
          <p>
            默认监听 <code>window.postMessage</code>，支持以下指令：
          </p>
          <ul>
            <li>
              <code>{ type: "drivePicker.config", payload: {"developerKey":"…"} }</code>
            </li>
            <li>
              <code>{ type: "drivePicker.token", payload: "ya29.…" }</code>
            </li>
            <li>
              <code>{ type: "drivePicker.open", payload?: ConfigPatch }</code>
            </li>
            <li><code>{ type: "drivePicker.reset" }</code></li>
          </ul>
          <p>
            也可以直接调用
            <code>window.DrivePickerChannel.injectConfig({...})</code>
            或 <code>window.DrivePickerChannel.openPicker()</code>。
          </p>
        </div>
      </section>
    </main>

    <script>
      (function () {
        const statusPanel = document.getElementById("statusPanel");
        const openPickerBtn = document.getElementById("openPickerBtn");
        const resetConfigBtn = document.getElementById("resetConfigBtn");
        const configView = document.getElementById("configView");
        const resultView = document.getElementById("resultView");

        const defaultConfig = {
          developerKey: "",
          appId: "",
          oauthToken: "",
          locale: "zh-CN",
          viewId: "DOCS",
          title: "选择 Drive 文件",
          mimeTypes: "",
          includeFolders: true,
          selectFolderEnabled: false,
          multiSelect: false,
          supportDrives: true,
          showUploadView: false,
          callbackEvent: "drivePicker.selection",
        };

        const allowedConfigKeys = Object.keys(defaultConfig);

        const state = {
          config: { ...defaultConfig },
          gapiReady: false,
          pickerReady: false,
        };

        function updateStatus(message) {
          const missingKeys = [];
          if (!state.config.developerKey) missingKeys.push("developerKey");
          if (!state.config.oauthToken) missingKeys.push("oauthToken");

          statusPanel.innerHTML = `
            <h2>当前状态</h2>
            <p><strong>api.js 已加载：</strong> ${
              state.gapiReady ? "是" : "否"
            }</p>
            <p><strong>picker SDK 已就绪：</strong> ${
              state.pickerReady ? "是" : "否"
            }</p>
            <p><strong>可直接唤起：</strong> ${
              state.pickerReady && missingKeys.length === 0 ? "是" : "否"
            }</p>
            <p><strong>缺失参数：</strong> ${
              missingKeys.length ? missingKeys.join(", ") : "(无)"
            }</p>
            ${message ? `<p>${message}</p>` : ""}
          `;

          openPickerBtn.disabled =
            !state.pickerReady || missingKeys.length > 0;
        }

        function format(value) {
          return JSON.stringify(value, null, 2);
        }

        function renderConfig() {
          configView.textContent = format(state.config);
        }

        function renderResult(result) {
          resultView.textContent = result
            ? format(result)
            : "(尚未唤起 Picker)";
        }

        function injectConfig(patch) {
          if (!patch || typeof patch !== "object") return;
          const next = { ...state.config };
          Object.keys(patch).forEach((key) => {
            if (!allowedConfigKeys.includes(key)) return;
            next[key] = patch[key];
          });
          state.config = next;
          renderConfig();
          updateStatus();
        }

        function resetConfig() {
          state.config = { ...defaultConfig };
          renderConfig();
          updateStatus("已恢复默认配置");
        }

        function emitSelection(payload, action) {
          const eventType = state.config.callbackEvent || "drivePicker.selection";
          try {
            window.parent?.postMessage(
              {
                type: eventType,
                status: action,
                payload,
              },
              "*"
            );
          } catch (err) {
            console.warn("postMessage 失败", err);
          }
        }

        function handlePickerAction(data) {
          if (!data) return;
          const action = data.action || "UNKNOWN";
          if (action === google.picker.Action.PICKED) {
            const docs = (data.docs || []).map((doc) => ({
              id: doc.id,
              name: doc.name,
              type: doc.type,
              mimeType: doc.mimeType,
              url: doc.url,
              sizeBytes: doc.sizeBytes,
            }));
            const payload = { action, docs };
            renderResult(payload);
            emitSelection(payload, action);
          } else if (action === google.picker.Action.CANCEL) {
            const payload = { action, message: "用户取消选择" };
            renderResult(payload);
            emitSelection(payload, action);
          } else {
            renderResult(data);
            emitSelection(data, action);
          }
        }

        function buildDocsView() {
          const viewIdName =
            typeof state.config.viewId === "string"
              ? state.config.viewId.toUpperCase()
              : "DOCS";
          const viewId =
            (google.picker.ViewId && google.picker.ViewId[viewIdName]) ||
            google.picker.ViewId.DOCS;
          const view = new google.picker.DocsView(viewId)
            .setIncludeFolders(Boolean(state.config.includeFolders))
            .setSelectFolderEnabled(Boolean(state.config.selectFolderEnabled));
          if (state.config.mimeTypes) {
            view.setMimeTypes(state.config.mimeTypes);
          }
          return view;
        }

        function openPicker() {
          if (!state.pickerReady) {
            updateStatus("Picker SDK 尚未就绪");
            return;
          }

          if (!state.config.developerKey || !state.config.oauthToken) {
            updateStatus("请通过 JS Channel 注入 developerKey 与 oauthToken");
            return;
          }

          const pickerBuilder = new google.picker.PickerBuilder()
            .setOAuthToken(state.config.oauthToken)
            .setDeveloperKey(state.config.developerKey)
            .setOrigin(window.location.origin)
            .setCallback(handlePickerAction);

          if (state.config.appId) {
            pickerBuilder.setAppId(state.config.appId);
          }

          if (state.config.locale) {
            pickerBuilder.setLocale(state.config.locale);
          }

          if (state.config.title) {
            pickerBuilder.setTitle(state.config.title);
          }

          if (state.config.multiSelect) {
            pickerBuilder.enableFeature(
              google.picker.Feature.MULTISELECT_ENABLED
            );
          }

          if (state.config.supportDrives) {
            pickerBuilder.enableFeature(google.picker.Feature.SUPPORT_DRIVES);
          }

          pickerBuilder.addView(buildDocsView());

          if (state.config.showUploadView) {
            pickerBuilder.addView(new google.picker.DocsUploadView());
          }

          const picker = pickerBuilder.build();
          picker.setVisible(true);
        }

        function handleMessage(event) {
          const data = event.data;
          if (!data || typeof data !== "object") return;
          switch (data.type) {
            case "drivePicker.config":
              injectConfig(data.payload || {});
              break;
            case "drivePicker.token":
              injectConfig({ oauthToken: data.payload });
              break;
            case "drivePicker.open":
              if (data.payload) injectConfig(data.payload);
              openPicker();
              break;
            case "drivePicker.reset":
              resetConfig();
              break;
            default:
              break;
          }
        }

        window.addEventListener("message", handleMessage);
        resetConfig();

        openPickerBtn.addEventListener("click", openPicker);
        resetConfigBtn.addEventListener("click", resetConfig);

        window.DrivePickerChannel = {
          injectConfig,
          reset: resetConfig,
          openPicker,
        };

        window.handleGapiLoaded = function handleGapiLoaded() {
          state.gapiReady = true;
          updateStatus();
          if (!window.gapi || !gapi.load) {
            updateStatus("gapi 未注入");
            return;
          }
          gapi.load("picker", {
            callback: function () {
              state.pickerReady = true;
              updateStatus();
            },
          });
        };

        updateStatus("等待注入配置…");
      })();
    </script>
    <script
      src="https://apis.google.com/js/api.js?onload=handleGapiLoaded"
      async
      defer
    ></script>
  </body>
</html>
